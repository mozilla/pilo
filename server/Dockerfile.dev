# Development Dockerfile for Spark server with hot reloading
FROM node:22-slim

# Install pnpm
RUN npm install -g pnpm

# Install system dependencies for Playwright
RUN apt-get update && apt-get install -y \
    wget \
    ca-certificates \
    fonts-liberation \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libc6 \
    libcairo2 \
    libcups2 \
    libdbus-1-3 \
    libexpat1 \
    libfontconfig1 \
    libgbm1 \
    libgcc1 \
    libglib2.0-0 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libstdc++6 \
    libx11-6 \
    libx11-xcb1 \
    libxcb1 \
    libxcomposite1 \
    libxcursor1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxi6 \
    libxrandr2 \
    libxrender1 \
    libxss1 \
    libxtst6 \
    lsb-release \
    xdg-utils \
    && rm -rf /var/lib/apt/lists/*

# Set working directory for the entire spark project
WORKDIR /app

# Copy all package files first for better caching
COPY package.json pnpm-lock.yaml ./
COPY server/package.json server/pnpm-lock.yaml ./server/

# Copy source files before install (needed for prepare script)
COPY src ./src
COPY tsconfig.json ./

# Install main package dependencies and build
RUN pnpm install
RUN pnpm run build

# Install Playwright browsers (Firefox) with dependencies
RUN cd /app && pnpm exec playwright install --with-deps firefox

# Install server dependencies 
WORKDIR /app/server
RUN pnpm install

# Copy server files but don't build (will use tsx --watch)
COPY server/src ./src
COPY server/tsconfig.json ./

# Expose the port
EXPOSE 3000

# Set environment variables for development
ENV NODE_ENV=development
ENV PATH="/app/server/node_modules/.bin:$PATH"
ENV NODE_PATH="/app/node_modules:/app/server/node_modules"

# Start the server with hot reloading using tsx --watch
# Note: .env files are automatically loaded by dotenv in Node.js applications
CMD ["pnpm", "run", "dev:tabs"]